version: '3'

run: when_changed

vars:
  CLIPPY_ARGS: >-
    --frozen --locked --release
    --all-targets
    --
    -W clippy::cargo
    -W clippy::pedantic
    -W clippy::style
    {{.CLIPPY_PEDANTIC}}
    {{.CLIPPY_STYLE}}
    {{.CLIPPY_RESTRICTIONS}}
    -D warnings

  CLIPPY_PEDANTIC: >-
    -A clippy::missing_errors_doc
    -A clippy::missing_panics_doc
    -A clippy::module_name_repetitions

  CLIPPY_STYLE: >-
    -A clippy::single_component_path_imports

  CLIPPY_RESTRICTIONS: >-
    -W clippy::absolute_paths
    -W clippy::dbg_macro
    -W clippy::exit
    -W clippy::panic_in_result_fn
    -W clippy::partial_pub_fields
    -W clippy::print_stderr
    -W clippy::print_stdout
    -W clippy::pub_without_shorthand
    -W clippy::self_named_module_files
    -W clippy::try_err
    -W clippy::unwrap_in_result

tasks:
  bin:install:
    cmds:
      # To avoid painful conflicts, don't use lockfile
      - cargo install cargo-deny --version 0.14.3
      - cargo install tantivy-cli --version 0.21.0

  build:debug:
    aliases:
      - build
      - b
    cmd: cargo build --all-targets --frozen --locked

  build:release:
    aliases:
      - br
    cmd: cargo build --all-targets --frozen --locked --release

  clean:
    cmd: cargo clean

  clippy:lint:check:
    cmd: cargo clippy {{.CLIPPY_ARGS}}

  clippy:lint:fix:
    cmd: cargo clippy --fix --allow-dirty --allow-staged {{.CLIPPY_ARGS}}

  deny:lint:
    cmd: cargo deny check

  execute-package:
    internal: true
    requires:
      vars:
        - MDOE
        - TEST
        - NAME
    cmd: build/target/{{.MODE}/intertwine-{{.NAME}}{{if eq .TEST "true"}}-test{{end}}

  fetch:
    cmd: cargo fetch --frozen --locked

  format:check:
    aliases:
      - fc
    cmd: cargo fmt --all -- --check

  format:fix:
    aliases:
      - format
      - f
    cmd: cargo fmt --all

  install:
    cmds:
      - task: fetch
      - task: bin:install

  lint:check:
    aliases:
      - lint
      - l
    deps:
      - clippy:lint:check
      - deny:lint

  lint:fix:
    aliases:
      - lf
    deps:
      - clippy:lint:fix
      - deny:lint

  lock:
    cmd: cargo metadata --format-version=1 >/dev/null

  lock:check:
    cmd: cargo metadata --frozen --locked --format-version=1 >/dev/null

  test:debug:
    aliases:
      - test
      - t
    deps:
      - build:debug
    cmd: cargo test

  test:release:
    aliases:
      - tr
    deps:
      - build:release
    cmd: cargo test --frozen --locked --release
