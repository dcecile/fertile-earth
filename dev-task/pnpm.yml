version: '3'

run: when_changed

vars:
  ESLINT_ARGS: "--ignore-path .gitignore --max-warnings 0 --ext ts,js,cjs $(dasel -f .eslintrc.json -r json -w - '.parserOptions.project.all()' | sed -e 's,/tsconfig\\.json$,,')"
  PRETTIER_ARGS: --ignore-path .gitignore --check '**/*'.{cjs,js,json,ts,html,md,yaml} '!pnpm-lock.yaml'

tasks:
  build:debug:
    deps:
      - esbuild:build:debug
      - tsc:build

  build:release:
    deps:
      - esbuild:build:release
      - tsc:build

  clean:
    deps:
      - clean:debug
      - clean:release

  clean:debug:
    deps:
      - esbuild:clean:debug
      - tsc:clean

  clean:release:
    deps:
      - esbuild:clean:release
      - tsc:clean

  esbuild:build:debug:
    cmd: dev-esbuild --mode development

  esbuild:build:debug:watch:
    cmd: dev-esbuild --mode development --watch

  esbuild:clean:debug:
    cmd: dev-esbuild --mode development --clean

  esbuild:clean:release:
    cmd: dev-esbuild --mode production --clean

  esbuild:build:release:
    cmd: dev-esbuild --mode production

  eslint:lint:check:
    cmd: eslint {{.ESLINT_ARGS}}

  eslint:lint:fix:
    cmd: eslint {{.ESLINT_ARGS}} --fix

  format:check:
    cmd: prettier {{.PRETTIER_ARGS}}

  format:fix:
    cmd: prettier {{.PRETTIER_ARGS}} --write

  install:
    cmd: pnpm install --frozen-lockfile

  lint:check:
    deps:
      - eslint:lint:check
      - syncpack:lint:check

  lint:fix:
    deps:
      - eslint:lint:fix
      - syncpack:lint:fix

  lock:check:
    cmd: pnpm install --frozen-lockfile --lockfile-only

  syncpack:lint:check:
    cmd: syncpack lint

  syncpack:lint:fix:
    cmds:
      - syncpack fix-mismatches
      - task: syncpack:lint:check

  tsc:clean:
    cmd: tsc --build --clean

  tsc:build:
    aliases:
      - tsc:b
    cmd: tsc --build --verbose

  tsc:build:watch:
    aliases:
      - tsc:bw
    cmd: tsc --build --verbose --watch

  test:
    cmd: dev-pnpm-test
